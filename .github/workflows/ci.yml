name: ci

on:
  pull_request:
    branches:
      - release
      - 'release-*'
  push:
    branches:
      - release
      - 'release-*'
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        ports:
          - 5432:5432
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: cli2ansible
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.7.1
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v3
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/pyproject.toml') }}

      - name: Install dependencies
        run: poetry install --no-interaction --no-ansi

      - name: Lint & Type check
        run: |
          poetry run ruff check .
          poetry run mypy src

      - name: Run Tests
        env:
          DATABASE_URL: postgresql+psycopg://postgres:postgres@localhost:5432/cli2ansible
        run: poetry run pytest --maxfail=1 --disable-warnings -q --cov=src --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
          override_branch: ${{ github.ref_name }}
          override_commit: ${{ github.sha }}

  # Augment AI Code Review with Auggie CLI
  augment-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Auggie CLI
        run: npm install -g @augmentcode/auggie

      - name: Authenticate Auggie
        env:
          AUGMENT_API_KEY: ${{ secrets.AUGMENT_API_KEY }}
        run: |
          # Auggie will use AUGMENT_API_KEY environment variable for authentication
          echo "âœ… Auggie authentication configured"

      - name: Run Auggie PR Review
        env:
          AUGMENT_API_KEY: ${{ secrets.AUGMENT_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Run Auggie in print mode with quiet flag for clean output
          # Rules in .augment/rules/ are automatically applied
          auggie --print --quiet "Review this PR following .augment/workflows/pr-review.md

          PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}

          Apply all rules from .augment/rules/ and generate a detailed review comment with:
          - Summary of changes
          - Critical issues (ðŸ”´) that must be fixed
          - Warnings (ðŸŸ¡) that should be addressed
          - Suggestions (ðŸ”µ) for improvements
          - Specific file/line references where applicable

          Format the output as markdown suitable for posting as a PR comment." > review-output.md

          echo "âœ… Auggie review completed"

      - name: Post Review Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const reviewContent = fs.readFileSync('review-output.md', 'utf8');

            // Post the AI-generated review as a comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.pull_request.number }},
              body: `## ðŸ¤– Augment AI Code Review\n\n${reviewContent}\n\n---\n*Review generated by [Auggie CLI](https://www.augmentcode.com/product/CLI) â€¢ [Rules](.augment/rules/)*`
            });

      - name: Check for Critical Issues
        run: |
          if grep -q "ï¿½" review-output.md; then
            echo "::warning::Critical issues found in code review"
            echo "critical_issues=true" >> $GITHUB_ENV
          else
            echo "critical_issues=false" >> $GITHUB_ENV
          fi

      - name: Upload Review Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: augment-review
          path: review-output.md
          retention-days: 30
